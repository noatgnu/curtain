<div class="network-interactions-container">
  <div class="row g-3">
    <div class="col-lg-3">
      <div class="settings-sidebar">
        <div class="card mb-2">
          <div class="card-header py-2 d-flex justify-content-between align-items-center">
            <span class="fw-semibold small">
              <i class="bi bi-gear me-1"></i>Network Parameters
            </span>
            <button
              class="btn btn-sm btn-outline-secondary"
              (click)="showSettings = !showSettings"
              [attr.aria-expanded]="showSettings"
              title="Toggle settings">
              <i class="bi" [class.bi-chevron-up]="showSettings" [class.bi-chevron-down]="!showSettings"></i>
            </button>
          </div>

          @if (showSettings) {
            <div class="card-body py-2">
              <form [formGroup]="form">
                <div class="accordion accordion-flush" id="settingsAccordion">
                  <div class="accordion-item">
                    <h2 class="accordion-header">
                      <button
                        class="accordion-button py-2 small"
                        [class.collapsed]="!showStringDbSettings"
                        type="button"
                        (click)="showStringDbSettings = !showStringDbSettings"
                        aria-expanded="true">
                        <i class="bi bi-diagram-2 me-2"></i>StringDB
                      </button>
                    </h2>
                    @if (showStringDbSettings) {
                      <div class="accordion-body py-2">
                        <div class="mb-2">
                          <label for="networkType" class="form-label small mb-1">Network Type</label>
                          <select
                            id="networkType"
                            formControlName="networkType"
                            class="form-select form-select-sm"
                            aria-label="StringDB network type">
                            <option value="functional">Functional</option>
                            <option value="physical">Physical</option>
                          </select>
                        </div>

                        <div class="mb-2">
                          <label class="form-label small mb-1">
                            Combined Score: {{ form.value.requiredScore | number:'1.2-2' }}
                          </label>
                          <input
                            type="range"
                            class="form-range"
                            formControlName="requiredScore"
                            min="0"
                            max="1"
                            step="0.05"
                            aria-label="Required combined score">
                        </div>

                        <div class="score-filters">
                          <div class="small text-muted mb-1">Score Filters (optional)</div>
                          @for (score of scoreDefinitions; track score.key) {
                            <div class="d-flex align-items-center gap-2 mb-1">
                              <span
                                class="score-label"
                                [ngbTooltip]="score.description"
                                placement="right">
                                {{ score.label }}
                              </span>
                              <input
                                type="range"
                                class="form-range flex-grow-1"
                                [formControlName]="score.key"
                                min="0"
                                max="1"
                                step="0.1"
                                [attr.aria-label]="score.label">
                              <span class="score-value">{{ form.value[score.key] | number:'1.1-1' }}</span>
                            </div>
                          }
                        </div>
                      </div>
                    }
                  </div>

                  <div class="accordion-item">
                    <h2 class="accordion-header">
                      <button
                        class="accordion-button py-2 small"
                        [class.collapsed]="!showInteractomeSettings"
                        type="button"
                        (click)="showInteractomeSettings = !showInteractomeSettings">
                        <i class="bi bi-diagram-3 me-2"></i>Interactome Atlas
                      </button>
                    </h2>
                    @if (showInteractomeSettings) {
                      <div class="accordion-body py-2">
                        <div class="mb-2">
                          <label class="form-label small mb-1">
                            Min Score: {{ form.value.atlasScore | number:'1.2-2' }}
                          </label>
                          <input
                            type="range"
                            class="form-range"
                            formControlName="atlasScore"
                            min="0"
                            max="1"
                            step="0.05"
                            aria-label="Interactome Atlas minimum score">
                        </div>
                      </div>
                    }
                  </div>

                  <div class="accordion-item">
                    <h2 class="accordion-header">
                      <button
                        class="accordion-button py-2 small"
                        [class.collapsed]="!showColorSettings"
                        type="button"
                        (click)="showColorSettings = !showColorSettings">
                        <i class="bi bi-palette me-2"></i>Colors
                      </button>
                    </h2>
                    @if (showColorSettings) {
                      <div class="accordion-body py-2">
                        <div class="color-legend">
                          <div class="small text-muted mb-2">Node Colors</div>
                          <div class="color-item">
                            <span
                              class="color-swatch"
                              [style.background]="colorMap['Increase']"
                              [(colorPicker)]="colorMap['Increase']"
                              (colorPickerChange)="updateColor($event, 'Increase')"></span>
                            <span class="small">Increased (FC &gt; {{ settings.settings.log2FCCutoff }})</span>
                          </div>
                          <div class="color-item">
                            <span
                              class="color-swatch"
                              [style.background]="colorMap['Decrease']"
                              [(colorPicker)]="colorMap['Decrease']"
                              (colorPickerChange)="updateColor($event, 'Decrease')"></span>
                            <span class="small">Decreased (FC &lt; -{{ settings.settings.log2FCCutoff }})</span>
                          </div>
                          <div class="color-item">
                            <span
                              class="color-swatch"
                              [style.background]="colorMap['No change']"
                              [(colorPicker)]="colorMap['No change']"
                              (colorPickerChange)="updateColor($event, 'No change')"></span>
                            <span class="small">No change</span>
                          </div>

                          <div class="small text-muted mb-2 mt-3">Text Colors</div>
                          <div class="color-item">
                            <span
                              class="color-swatch"
                              [style.background]="colorMap['Significant']"
                              [(colorPicker)]="colorMap['Significant']"
                              (colorPickerChange)="updateColor($event, 'Significant')"></span>
                            <span class="small">Significant (p &le; {{ settings.settings.pCutoff }})</span>
                          </div>
                          <div class="color-item">
                            <span
                              class="color-swatch"
                              [style.background]="colorMap['Not significant']"
                              [(colorPicker)]="colorMap['Not significant']"
                              (colorPickerChange)="updateColor($event, 'Not significant')"></span>
                            <span class="small">Not significant</span>
                          </div>

                          <div class="small text-muted mb-2 mt-3">Edge Colors</div>
                          <div class="color-item">
                            <span
                              class="color-swatch"
                              [style.background]="colorMap['StringDB']"
                              [(colorPicker)]="colorMap['StringDB']"
                              (colorPickerChange)="updateColor($event, 'StringDB')"></span>
                            <span class="small">StringDB</span>
                          </div>
                          <div class="color-item">
                            <span
                              class="color-swatch"
                              [style.background]="colorMap['InteractomeAtlas']"
                              [(colorPicker)]="colorMap['InteractomeAtlas']"
                              (colorPickerChange)="updateColor($event, 'InteractomeAtlas')"></span>
                            <span class="small">Interactome Atlas</span>
                          </div>
                        </div>
                      </div>
                    }
                  </div>
                </div>
              </form>

              <button
                class="btn btn-primary btn-sm w-100 mt-2"
                (click)="getInteractions()"
                [disabled]="loading"
                aria-label="Redraw network">
                @if (loading) {
                  <span class="spinner-border spinner-border-sm me-1"></span>
                } @else {
                  <i class="bi bi-arrow-repeat me-1"></i>
                }
                Redraw Network
              </button>
            </div>
          }
        </div>

        @if (networkStats.totalNodes > 0) {
          <div class="card mb-2">
            <div class="card-header py-2">
              <span class="fw-semibold small"><i class="bi bi-bar-chart me-1"></i>Statistics</span>
            </div>
            <div class="card-body py-2">
              <div class="stats-grid">
                <div class="stat-item">
                  <span class="stat-value">{{ networkStats.totalNodes }}</span>
                  <span class="stat-label">Nodes</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value">{{ networkStats.totalEdges }}</span>
                  <span class="stat-label">Edges</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value text-success">{{ networkStats.increasedNodes }}</span>
                  <span class="stat-label">Increased</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value text-danger">{{ networkStats.decreasedNodes }}</span>
                  <span class="stat-label">Decreased</span>
                </div>
              </div>

              <div class="mt-2 small">
                <div class="d-flex justify-content-between">
                  <span class="text-muted">StringDB edges:</span>
                  <strong>{{ networkStats.stringDbEdges }}</strong>
                </div>
                <div class="d-flex justify-content-between">
                  <span class="text-muted">Interactome edges:</span>
                  <strong>{{ networkStats.interactomeEdges }}</strong>
                </div>
                <div class="d-flex justify-content-between">
                  <span class="text-muted">Significant:</span>
                  <strong>{{ networkStats.significantNodes }}</strong>
                </div>
              </div>

              @if (getTopConnectedGenes(3).length > 0) {
                <div class="mt-2 pt-2 border-top">
                  <div class="small text-muted mb-1">Top Connected</div>
                  @for (item of getTopConnectedGenes(3); track item.gene) {
                    <div class="d-flex justify-content-between small">
                      <span>{{ item.gene }}</span>
                      <span class="badge bg-secondary">{{ item.connections }}</span>
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        }

        @if (showEdgePanel && edgeDataViewer[edgeDataSource]) {
          <div class="card edge-panel">
            <div class="card-header py-2 d-flex justify-content-between align-items-center">
              <span class="fw-semibold small">
                <i class="bi bi-link-45deg me-1"></i>
                {{ edgeDataSource === 'stringdb' ? 'StringDB' : 'Interactome' }} Edge
              </span>
              <button class="btn btn-sm btn-close" (click)="closeEdgePanel()" aria-label="Close"></button>
            </div>
            <div class="card-body py-2">
              @if (edgeDataSource === 'stringdb') {
                <div class="edge-details small">
                  <div class="edge-nodes mb-2">
                    <strong>{{ edgeDataViewer[edgeDataSource]["preferredName_A"] }}</strong>
                    <i class="bi bi-arrow-left-right mx-2"></i>
                    <strong>{{ edgeDataViewer[edgeDataSource]["preferredName_B"] }}</strong>
                  </div>
                  <div class="d-flex justify-content-between">
                    <span>Combined Score:</span>
                    <strong>{{ edgeDataViewer[edgeDataSource]["score"] }}</strong>
                  </div>
                  @for (score of scoreDefinitions; track score.key) {
                    <div class="d-flex justify-content-between">
                      <span [ngbTooltip]="score.description">{{ score.label }}:</span>
                      <span>{{ edgeDataViewer[edgeDataSource][score.key] }}</span>
                    </div>
                  }
                </div>
              } @else {
                <div class="edge-details small">
                  <div class="edge-nodes mb-2">
                    <strong>{{ edgeDataViewer[edgeDataSource]["interactor_A"]["protein_gene_name"] }}</strong>
                    <i class="bi bi-arrow-left-right mx-2"></i>
                    <strong>{{ edgeDataViewer[edgeDataSource]["interactor_B"]["protein_gene_name"] }}</strong>
                  </div>
                  <div class="d-flex justify-content-between">
                    <span>Score:</span>
                    <strong>{{ edgeDataViewer[edgeDataSource]["score"] }}</strong>
                  </div>
                </div>
              }
            </div>
          </div>
        }
      </div>
    </div>

    <div class="col-lg-9">
      <div class="network-main">
        <div class="toolbar mb-2">
          <div class="d-flex flex-wrap gap-2 align-items-center">
            <div class="input-group input-group-sm" style="max-width: 200px;">
              <input
                type="text"
                class="form-control"
                placeholder="Search genes..."
                [(ngModel)]="searchTerm"
                (input)="onSearchChange()"
                aria-label="Search genes">
              @if (searchTerm) {
                <button class="btn btn-outline-secondary" (click)="clearSearch()" title="Clear">
                  <i class="bi bi-x"></i>
                </button>
              }
            </div>

            <select
              class="form-select form-select-sm"
              style="max-width: 150px;"
              [(ngModel)]="edgeSourceFilter"
              (change)="onEdgeSourceFilterChange()"
              aria-label="Filter by source">
              <option value="all">All Sources</option>
              <option value="stringdb">StringDB Only</option>
              <option value="interactome">Interactome Only</option>
            </select>

            <select
              class="form-select form-select-sm"
              style="max-width: 140px;"
              [(ngModel)]="layoutType"
              (change)="onLayoutChange()"
              aria-label="Layout type">
              @for (layout of layoutOptions; track layout.value) {
                <option [value]="layout.value">{{ layout.label }}</option>
              }
            </select>

            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-secondary" (click)="zoomIn()" title="Zoom in">
                <i class="bi bi-zoom-in"></i>
              </button>
              <button class="btn btn-outline-secondary" (click)="zoomOut()" title="Zoom out">
                <i class="bi bi-zoom-out"></i>
              </button>
              <button class="btn btn-outline-secondary" (click)="fitToView()" title="Fit to view">
                <i class="bi bi-arrows-fullscreen"></i>
              </button>
            </div>

            <app-comparison-selections (selection)="handleSelection($event)"></app-comparison-selections>

            <div class="ms-auto d-flex gap-1">
              <button class="btn btn-sm btn-outline-secondary" (click)="saveNetwork()" title="Save configuration">
                <i class="bi bi-save"></i>
              </button>
              <div class="btn-group btn-group-sm" ngbDropdown>
                <button class="btn btn-outline-secondary" ngbDropdownToggle title="Export">
                  <i class="bi bi-download"></i>
                </button>
                <div ngbDropdownMenu>
                  <button ngbDropdownItem (click)="downloadPNG()">
                    <i class="bi bi-filetype-png me-2"></i>PNG Image
                  </button>
                  <button ngbDropdownItem (click)="downloadSVG()">
                    <i class="bi bi-filetype-svg me-2"></i>SVG Vector
                  </button>
                  <div class="dropdown-divider"></div>
                  <button ngbDropdownItem (click)="exportNodesCSV()">
                    <i class="bi bi-filetype-csv me-2"></i>Nodes CSV
                  </button>
                  <button ngbDropdownItem (click)="exportEdgesCSV()">
                    <i class="bi bi-filetype-csv me-2"></i>Edges CSV
                  </button>
                  <div class="dropdown-divider"></div>
                  <button ngbDropdownItem (click)="copyNodesToClipboard()">
                    <i class="bi bi-clipboard me-2"></i>Copy Gene List
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="network-container">
          @if (loading) {
            <div class="loading-overlay" role="status" aria-live="polite">
              <div class="text-center">
                <div class="spinner-border text-primary mb-2" style="width: 3rem; height: 3rem;">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="text-muted mb-0">{{ loadingMessage }}</p>
              </div>
            </div>
          }

          @if (error) {
            <div class="alert alert-warning m-3" role="alert">
              <i class="bi bi-exclamation-triangle me-2"></i>{{ error }}
            </div>
          }

          <app-cytoplot
            #cytoplot
            [dimensions]="{width: '100%', height: 600}"
            [drawData]="result"
            (clickedID)="handleSelect($event)"
            (ready)="saveNetwork()">
          </app-cytoplot>

          @if (!loading && networkStats.totalNodes === 0 && _genes.length > 0) {
            <div class="empty-state">
              <i class="bi bi-diagram-3 display-1 text-muted"></i>
              <p class="text-muted mt-2">No interactions found for the selected proteins</p>
              <p class="small text-muted">Try adjusting the score thresholds</p>
            </div>
          }
        </div>

        @if (highlightedNodes.size > 0) {
          <div class="highlight-info mt-2">
            <span class="badge bg-warning text-dark">
              <i class="bi bi-search me-1"></i>
              {{ highlightedNodes.size }} gene(s) highlighted
            </span>
          </div>
        }
      </div>
    </div>
  </div>
</div>
