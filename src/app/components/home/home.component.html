<app-toast-container></app-toast-container>
<router-outlet></router-outlet>

<nav class="navbar navbar-expand-lg fixed-top shadow-sm" [attr.data-bs-theme]="themeService.getCurrentTheme()" style="background-color: var(--app-bg-secondary); backdrop-filter: blur(10px);">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="#">Curtain</a>

    @if (progressEvent && !finished) {
      <div class="glitch-element me-auto">
        <span class="text-info">{{progressEvent.text}}</span>
      </div>
    }

    @if (settings.newVersionAvailable) {
      <div>
        <span class="badge bg-warning">New Curtain version available</span>
      </div>
    }



    <div class="d-flex align-items-center">
      @if (settings.settings.encrypted) {
        <div class="me-2" (click)="testEncryptSave()">
          <span class="badge bg-danger">Encryption Enabled</span>
        </div>
      }
      @if (accounts.curtainAPI.user.loginStatus) {
        <div class="me-2">
          <div display="dynamic" ngbDropdown>
            <button class="btn btn-outline-primary" id="doiManagement" ngbDropdownToggle>
              DOI Management
              @if (data.draftDataCiteCount > 0) {
                <span class="badge bg-danger ms-1">{{data.draftDataCiteCount}}</span>
              }
            </button>
            <div ngbDropdownMenu aria-labelledby="doiManagement">
              <button ngbDropdownItem (click)="openDataciteAdminManagement()">
                Submitted DOI @if (data.draftDataCiteCount > 0) {<span class="badge bg-danger ms-1">{{data.draftDataCiteCount}}</span>}
              </button>
              @if (finished() && gdprAccepted() && data.session) {
                <button ngbDropdownItem (click)="openDataciteDOI()"
                        [disabled]="!data.session">
                  {{data.session.data_cite ? 'View DOI Form' : 'Register DOI (Beta)'}}
                </button>
              }
            </div>
          </div>
        </div>
      }
      @if (finished()) {
        <div class="me-2">
          <div display="dynamic" ngbDropdown>
            <button class="btn btn-outline-primary" id="localState" ngbDropdownToggle>
              <i class="bi bi-save"></i> State
            </button>
            <div ngbDropdownMenu aria-labelledby="localState">
              <button ngbDropdownItem (click)="saveLocalState()">Create local state</button>
              <button ngbDropdownItem (click)="openStateModal()">State Management</button>
            </div>
          </div>
        </div>
      }


      <!-- Plot Options Button -->
      <div class="me-2">
        <div display="dynamic" ngbDropdown>
          <button class="btn btn-outline-primary" id="plot-dropdown" ngbDropdownToggle>
            <i class="bi bi-graph-up"></i> Plot
          </button>
          <div ngbDropdownMenu aria-labelledby="plot-dropdown">
            @if (finished()) {
              <h6 class="dropdown-header">Data Visualization</h6>
              <button ngbDropdownItem (click)="openCorrelationMatrix()">Correlation Matrix</button>
              <button ngbDropdownItem (click)="openProfileCompare()">
                Profile Plot <span class="badge bg-secondary ms-1">{{settings.settings.selectedComparison.length}}</span>
              </button>
              <button ngbDropdownItem (click)="getSelectedList()">Get Selected Protein List</button>
              <button ngbDropdownItem (click)="openSampleSettings()">Sample Order & Visibility</button>
              <div class="dropdown-divider"></div>
            }
            <button ngbDropdownItem (click)="openColorPaletteModal()">Customize Color Palette</button>
            @if (data.selectOperationNames.length > 0) {
              <button ngbDropdownItem (click)="openSelectedDataDistributionModal()">Fold Change Distribution</button>
            }
          </div>
        </div>
      </div>

      @if (accounts.curtainAPI.user.loginStatus) {
        <div class="me-2">
          <div display="dynamic" ngbDropdown>
            <button class="btn btn-outline-primary" id="dropdownAccount" ngbDropdownToggle>
              <i class="bi bi-person-circle"></i> Account
            </button>
            <div ngbDropdownMenu aria-labelledby="dropdownAccount" class="dropdown-menu-end">
              <h6 class="dropdown-header">Account Management</h6>
              <button ngbDropdownItem (click)="openAccountModal()">
                <i class="bi bi-person"></i> My Account
              </button>
              <button ngbDropdownItem (click)="openAPIKeyModal()">
                <i class="bi bi-key"></i> API Keys
              </button>
              <div class="dropdown-divider"></div>
              <button ngbDropdownItem (click)="accounts.logout()">
                <i class="bi bi-box-arrow-right"></i> Logout
              </button>
            </div>
          </div>
        </div>
      }

      @if (accounts.curtainAPI.user.loginStatus) {
        <div class="me-2">
          <div display="dynamic" ngbDropdown>
            <button class="btn btn-outline-primary" id="dropdownCollections" ngbDropdownToggle>
              <i class="bi bi-folder2-open"></i>
              @if (selectedCollection) {
                {{selectedCollection.name}}
              } @else {
                Collections
              }
              <span class="badge bg-info ms-1">{{sessionCollections.length}}</span>
            </button>
            <div ngbDropdownMenu aria-labelledby="dropdownCollections" class="dropdown-menu-end">
              @if (sessionCollections.length > 0) {
                <h6 class="dropdown-header">
                  <i class="bi bi-folder2-open me-2"></i>Select Collection
                </h6>
                @for (collection of sessionCollections; track collection.id) {
                  <button
                    ngbDropdownItem
                    (click)="selectCollection(collection.id)"
                    [class.active]="selectedCollectionId === collection.id">
                    <i class="bi bi-check2 me-2" [class.invisible]="selectedCollectionId !== collection.id"></i>
                    {{collection.name}}
                    <span class="badge bg-info ms-2">{{collection.curtain_count}}</span>
                  </button>
                }
                <div class="dropdown-divider"></div>
              }
              <button ngbDropdownItem (click)="openCollectionManagementModal()">
                <i class="bi bi-plus-circle me-2"></i>Add Current Session to Collection
              </button>
              @if (selectedCollectionId) {
                <button ngbDropdownItem (click)="openCollectionSessionsModal()">
                  <i class="bi bi-eye me-2"></i>View Sessions in Collection
                </button>
              }
            </div>
          </div>
        </div>
      }

      <div class="me-2">
        <div display="dynamic" ngbDropdown>
          <button class="btn btn-outline-primary" id="dropdownSession" ngbDropdownToggle>
            <i class="bi bi-folder"></i> Session
            @if (data.session) {
              <span class="badge ms-1"
                    [ngClass]="{'bg-danger': !data.session.enable, 'bg-primary': data.session.enable}">
              {{data.session.enable ? 'shareable' : 'private'}}
              </span>
            }

          </button>
          <div ngbDropdownMenu aria-labelledby="dropdownSession" class="dropdown-menu-end" style="max-height: 80vh; overflow-y: auto;">
            <h6 class="dropdown-header">Project Data</h6>
            <button ngbDropdownItem (click)="openAnnotation()">Project Annotation</button>
            <button ngbDropdownItem (click)="openPeptideCountModal()">Add Peptide Count Data</button>
            <button ngbDropdownItem (click)="openLogFileModal()">Log File</button>
            <button ngbDropdownItem (click)="openAddRawDataImputationMap()">Add Imputation Data</button>
            @if (finished()) {
              <div class="dropdown-divider"></div>
              <h6 class="dropdown-header">Session Actions</h6>
            }
            @if (accounts.curtainAPI.user.loginStatus && accounts.curtainAPI.user.isStaff) {
              <button ngbDropdownItem (click)="openBatchSessionCreator()">
                Batch Session Creation
              </button>
            }
            @if (finished()) {
              @if(gdprAccepted()) {
                <button ngbDropdownItem (click)="saveSession()" [disabled]="data.tempLink">
                  <i class="bi bi-save me-1"></i>Save Session
                </button>
                @if (accounts.curtainAPI.user.loginStatus && data.session) {
                  <button ngbDropdownItem (click)="openDataciteDOI()">
                    {{data.session.data_cite ? 'View DOI Form' : 'Register DOI (Beta)'}}
                  </button>
                }
                @if (accounts.curtainAPI.user.loginStatus && data.session && !data.session.permanent) {
                  <button ngbDropdownItem (click)="openPermanentLinkRequestModal()">
                    <i class="bi bi-clock-history me-1"></i>Request Session Change
                  </button>
                }
                @if (accounts.curtainAPI.user.loginStatus && data.session) {
                  <button ngbDropdownItem (click)="openCollectionManagementModal()">
                    <i class="bi bi-folder2-open me-1"></i>Manage Collections
                  </button>
                }
              } @else {
                <button ngbDropdownItem disabled>Accept GDPR to Enable Saving</button>
              }
              <div class="dropdown-divider"></div>
              <h6 class="dropdown-header">Data Management</h6>
              <button ngbDropdownItem (click)="clearSelections()">Clear Selections</button>
              @if (hasSavedClearSettings()) {
                <button ngbDropdownItem (click)="removeClearSettings()">Remove Clear Selection Settings</button>
              }
              <button ngbDropdownItem (click)="web.downloadFile('different.txt', data.differential.originalFile)">
                Download Differential File
              </button>
              <button ngbDropdownItem (click)="web.downloadFile('raw.txt', data.raw.originalFile)">
                Download Raw File
              </button>
              <button ngbDropdownItem (click)="openEnrichrModal()">Enrichr Analysis</button>
              <button ngbDropdownItem (click)="selectionManagementModal()">Selection Management</button>
              <button ngbDropdownItem (click)="openSampleAndConditionModal()">Sample & Condition Assignment</button>
              @if (settings.settings.currentID !== '') {
                <button ngbDropdownItem (click)="openCompareSessionModal()">
                  Compare Sessions
                </button>
              }
            }
            <div class="dropdown-divider"></div>
            <h6 class="dropdown-header">Settings</h6>
            <button ngbDropdownItem (click)="openSessionSettings()"
                    [disabled]="!accounts.isOwner && !accounts.curtainAPI.user.isStaff">
              Session Settings
            </button>
            <button ngbDropdownItem (click)="openCollaborateModal()">Collaborate</button>
            <button ngbDropdownItem (click)="openEncryptionSettings()">Encryption Settings</button>
            <div class="dropdown-divider"></div>
            <h6 class="dropdown-header">Help & Resources</h6>
            <a ngbDropdownItem href="https://www.youtube.com/channel/UCwTAaXMvmqoozLB0XwZz20g" target="_blank">
              <i class="bi bi-youtube"></i> Video Tutorials
            </a>
            <a ngbDropdownItem href="https://groups.google.com/g/curtain-proteomics" target="_blank">
              <i class="bi bi-google"></i> Support Group
            </a>
            <a ngbDropdownItem href="https://curtain-docs.proteo.info" target="_blank">
              <i class="bi bi-book"></i> Documentation
            </a>
            @if (!accounts.curtainAPI.user.loginStatus) {
              <div class="dropdown-divider"></div>
              <button ngbDropdownItem (click)="openLoginModal()">
                <i class="bi bi-box-arrow-in-right"></i> Login
              </button>
            }
          </div>
        </div>
      </div>

      <!-- Theme Selector -->
      <div class="me-2">
        <div display="dynamic" ngbDropdown>
          <button class="btn btn-outline-secondary" id="dropdownTheme" ngbDropdownToggle>
            @if (isDarkMode()) {
              <i class="bi bi-moon-fill"></i>
            } @else {
              <i class="bi bi-sun-fill"></i>
            }
          </button>
          <div ngbDropdownMenu aria-labelledby="dropdownTheme" class="dropdown-menu-end">
            <h6 class="dropdown-header">
              <i class="bi bi-palette me-2"></i>Theme
            </h6>
            @for (theme of availableThemes; track theme.name) {
              <button
                ngbDropdownItem
                (click)="selectTheme(theme.name)"
                [class.active]="currentThemeName === theme.name">
                <i class="bi bi-check2 me-2" [class.invisible]="currentThemeName !== theme.name"></i>
                {{theme.displayName}}
              </button>
            }
            <div class="dropdown-divider"></div>
            <h6 class="dropdown-header">
              <i class="bi bi-brightness-high me-2"></i>Mode
            </h6>
            <button ngbDropdownItem (click)="setThemeMode('light')" [class.active]="!isDarkMode()">
              <i class="bi bi-check2 me-2" [class.invisible]="isDarkMode()"></i>
              <i class="bi bi-sun me-1"></i>Light
            </button>
            <button ngbDropdownItem (click)="setThemeMode('dark')" [class.active]="isDarkMode()">
              <i class="bi bi-check2 me-2" [class.invisible]="!isDarkMode()"></i>
              <i class="bi bi-moon me-1"></i>Dark
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</nav>

<div class="container mt-5 pt-3">
  @if (showAlert()) {
    <ngb-alert type="warning" [dismissible]="true" (closed)="closeGDPR()">
      <h5><i class="bi bi-shield-check"></i> GDPR Statement</h5>
      <p>
        This website neither uses cookies nor tracks/logs IPs of its users. The only personal identification data
        that we store is ORCID ID so that users can track their submitted sessions.
      </p>
      <p>
        It is the responsibility of the user to ensure no personal identification data is submitted. By saving
        data to CURTAIN, you confirm there is no personal identification data in your submitted information.
      </p>
      <div class="form-check">
        <input type="checkbox" class="form-check-input" [(ngModel)]="gdprAccepted" style="border-color: red">
        <label class="form-check-label"><strong>I have read and accepted the GDPR statement (Enable Session Saving)</strong></label>
      </div>
    </ngb-alert>
  }

  @if (currentAnnouncement()) {
    <ngb-alert [type]="getAnnouncementClass(currentAnnouncement()!.announcement_type)" [dismissible]="true" (closed)="dismissAnnouncement(currentAnnouncement()!.id)">
      <h5><i class="bi bi-megaphone-fill me-2"></i>{{currentAnnouncement()!.title}}</h5>
      <p>{{currentAnnouncement()!.content}}</p>
    </ngb-alert>
  }
</div>

@if (isDOI()) {
  <div class="container">
    @if (doiMetadata) {
      <app-datacite-metadata-display [metadata]="doiMetadata"
                                     (clickDownload)="handleDataCiteClickDownload($event)">
      </app-datacite-metadata-display>
    } @else {
      @if (loadingDataCite()) {
        @if (!doiMetadata) {
        <div class="mb-4">
          <ngb-progressbar [animated]="true" [value]="100" [striped]="true">Retrieving MetaData</ngb-progressbar>
        </div>
        }
      }
    }
  </div>
}

<!-- Floating Session Link Panel -->
@if (finished() && settings.settings.currentID !== '' && uniqueLink !== '' && !sessionLinkDismissed()) {
  <div class="alert alert-dismissible fade show shadow-lg"
       style="position: fixed; top: 80px; right: 20px; z-index: 1029; max-width: 600px; width: 90%;"
       [ngClass]="{
         'alert-danger': !permanent(),
         'alert-warning': permanent() && isDOI() && data.session?.data_cite?.status === 'draft',
         'alert-success': permanent() && (!isDOI() || data.session?.data_cite?.status === 'published'),
         'alert-info': permanent() && isDOI() && data.session?.data_cite?.status !== 'draft' && data.session?.data_cite?.status !== 'published'
       }">
    <button type="button" class="btn-close" (click)="dismissSessionLink()" aria-label="Close"></button>
    <div class="d-flex align-items-center">
      <div class="flex-grow-1 me-3">
        <h6 class="alert-heading mb-2">
          <i class="bi bi-link-45deg me-2"></i>Session Link
          @if (!permanent()) {
            <span class="badge bg-dark ms-2">Temporary</span>
          } @else {
            @if (isDOI() && data.session?.data_cite) {
              <span class="badge bg-dark ms-2">
                {{data.session?.data_cite?.status === 'draft' ? 'DOI Draft' :
                    data.session?.data_cite?.status === 'published' ? 'DOI Permanent' : 'DOI Pending'}}
              </span>
            } @else {
              @if (!isDOI()) {
                <span class="badge bg-dark ms-2">Permanent</span>
              }
            }
          }
        </h6>
        <div class="small mb-2">
          <a [href]="uniqueLink" class="text-decoration-none fw-bold" target="_blank" style="word-break: break-all;">
            {{uniqueLink}}
          </a>
        </div>
        @if (!permanent()) {
          <div class="small text-muted">
            <i class="bi bi-info-circle me-1"></i>
            This is a temporary link. Save your session to make it permanent.
          </div>
        }
      </div>
      <div class="d-flex flex-column gap-2">
        <button [ngClass]="isDarkMode() ? 'btn btn-sm btn-outline-light' : 'btn btn-sm btn-outline-dark'" (click)="copyToClipboard(uniqueLink)" title="Copy to clipboard">
          <i class="bi bi-clipboard"></i>
        </button>
        <button [ngClass]="isDarkMode() ? 'btn btn-sm btn-outline-light' : 'btn btn-sm btn-outline-dark'" (click)="openQRCode()" title="Show QR code">
          <i class="bi bi-qr-code"></i>
        </button>
      </div>
    </div>
  </div>
}

<app-pride></app-pride>
<app-file-form (finished)="handleFinish($event)"></app-file-form>

@if (finished()) {
  @if (data.raw.df.count() > 0) {
    <div class="container mt-4">
      <div class="accordion">
        <div class="accordion-item">
          <div class="accordion-header">
            <button class="accordion-button" [class.collapsed]="isRankPlotCollapse()" type="button" (click)="isRankPlotCollapse.set(!isRankPlotCollapse())">
              <div class="d-flex justify-content-between align-items-center w-100">
                <span>Rank Abundance Plot</span>
                <span class="badge bg-primary ms-2">{{data.raw.df.count()}} Primary IDs</span>
              </div>
            </button>
          </div>
          <div class="accordion-collapse" [ngbCollapse]="isRankPlotCollapse()">
            <div class="accordion-body">
              @if (!isRankPlotCollapse()) {
                <app-rank-plot [data]="data.raw.df"></app-rank-plot>
              }
            </div>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- Protein Selections -->
  <app-protein-selections (searchResult)="handleSearch($event)"></app-protein-selections>

  <!-- Volcano and Cyto -->
  <app-volcano-and-cyto (selected)="handleSearch($event)"></app-volcano-and-cyto>

  <!-- Raw Data Viewer -->
  @if (rawFiltered.count() > 0) {
    <div class="container-fluid mt-4">
      <app-raw-data-viewer [data]="rawFiltered"></app-raw-data-viewer>
    </div>
  }
}

@if (finished()) {
  @if (finished()) {
    <app-side-float-control (searchChatSelection)="handleSearch($event)"></app-side-float-control>
  }
}
